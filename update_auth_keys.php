#!/usr/bin/env php
<?php
require_once(dirname(__FILE__).'/bootstrap.php');

class UpdateAuthKeys
{
    public function run()
    {
        $Gitosis = Model_Gitosis::getInstance();
        $users = $Gitosis->getUsers();
        $auth_keys = '# autogenerated file. Do not edit';
        foreach ($users as $user) {
            foreach (array_filter(explode("\n", $user['public_key'])) as $key) {
                $auth_keys .= PHP_EOL . \GitPHP_Gitosis::formatKeyString(dirname(__FILE__), $user['username'], $key);
            }
        }
        file_put_contents(\GitPHP_Gitosis::HOME . \GitPHP_Gitosis::KEYFILE, $auth_keys);
    }
}

$Application = new GitPHP_Application();
$Application->init();

$Script = new UpdateAuthKeys();
$Script->run();
